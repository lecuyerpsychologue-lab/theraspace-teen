<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TheraSpace</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { --bg-color: #FDFBF7; --text-main: #2D3748; --color-coral: #FF8FAB; --color-teal: #2A9D8F; --color-yellow: #E9C46A; }
    html, body { height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-main); font-family: 'Outfit', sans-serif; overflow: hidden; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    #root { height: 100dvh; width: 100%; display: flex; flex-direction: column; }
    .no-scroll::-webkit-scrollbar { display: none; }
    .card { background: white; border-radius: 30px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02); }
    .input-soft { background: #F3F4F6; border-radius: 15px; border: 2px solid transparent; outline: none; color: #4B5563; transition: 0.3s; width: 100%; padding: 1rem; }
    .input-soft:focus { border-color: var(--color-coral); background: white; }
    @keyframes fade { from { opacity: 0; } to { opacity: 1; } } .anim-fade { animation: fade 0.4s ease-out; }
    @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.6); opacity: 1; } } .anim-breathe { animation: breathe 10s infinite ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- SCRIPT ERREUR VISUEL -->
  <div id="err" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;color:red;padding:20px;z-index:9999;">
    <h2>Erreur Critique</h2><pre id="errmsg" style="font-size:12px; margin-top:10px; border:1px solid #ddd; padding:10px;"></pre>
  </div>
  <script>window.onerror = function(m,s,l){document.getElementById('err').style.display='block';document.getElementById('errmsg').innerText=m+' (L:'+l+')';}</script>

  <script type="text/babel">
    /* --- 1. ICONES SVG (INLINE) --- */
    const Icon = ({ name, size, className, color }) => {
      const s = size || 24;
      const c = color || "currentColor";
      const cn = className || "";
      
      const paths = {
        Logo: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z",
        Home: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z",
        Echo: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z",
        Hero: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
        Oracle: "M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z",
        Identity: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
        Breath: "M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2",
        Journal: "M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z",
        Therapist: "M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-6 9h-4v-2h4v2zm0-4h-4V5h4v2z",
        Alert: "M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z",
        ArrowLeft: "M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z",
        Lock: "M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z",
        Play: "M8 5v14l11-7z",
        Plus: "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
        X: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
        Send: "M2.01 21L23 12 2.01 3 2 10l15 2-15 2z",
        Check: "M20 6L9 17l-5-5",
        Share2: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
        SkipForward: "M5 4l10 8-10 8V4zM19 5v14",
        Sparkles: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
        Zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
        Crown: "M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14",
        MessageCircle: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7",
        Moon: "M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z",
        Sun: "M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2",
        Heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
        Fingerprint: "M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 6",
        Clock: "M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zM12 6v6l4 2",
        UserCircle: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"
      };
      
      const d = paths[name] || "";
      const isPath = d.startsWith("M");
      return React.createElement("svg", {
        xmlns:"http://www.w3.org/2000/svg", width:s, height:s, viewBox:"0 0 24 24", fill:isPath?c:"none", stroke:isPath?"none":c, strokeWidth:"2", strokeLinecap="round", strokeLinejoin="round", className:`${cn} icon-glow`
      }, isPath ? React.createElement("path", {d}) : React.createElement("path", {d, stroke:"currentColor", fill:"none"}));
    };

    /* --- 2. API CLIENT --- */
    const callAPI = async (mode, data={}, context={}, history=[]) => {
      try {
        const res = await fetch('/api/chat', { 
          method: 'POST', 
          headers: {'Content-Type':'application/json'}, 
          body: JSON.stringify({mode, data, context, history}) 
        });
        if(!res.ok) throw new Error();
        return await res.json();
      } catch (e) {
        // Fallbacks
        if(mode==='GENERATE_SCENARIOS') return Array.from({length:15}, (_,i)=>({id:i, text:`Situation Exemple ${i+1}.`, type: i%2===0?'pos':'neg'}));
        if(mode==='GENERATE_ORACLE') return {title:"Le Sage", story:"Le silence est une rÃ©ponse.", moral:"Patience.", source:"Proverbe"};
        if(mode==='GENERATE_IDENTITY_QS') return ["Ton surnom ?", "Ta passion ?"];
        if(mode==='ANALYZE_HERO') return {archetype:"Le BÃ¢tisseur", analysis:"Base solide.", roadmap:Array.from({length:8},(_,i)=>({week:i+1, focus:`S${i+1}`, tasks:["A","B","C"]}))};
        if(mode==='SYNTHESIZE_IDENTITY') return {text: "Tu es une personne riche."};
        if(mode==='ANALYZE_ECHO') return {weather:{icon:"Sun", text:"Beau fixe"}, analysis:"Tu gÃ¨res bien."};
        if(mode==='CHAT_THERAPIST') return {text: "Mode hors ligne."};
        return null;
      }
    };

    /* --- 3. DATA STATIC --- */
    const EMOTIONS = [{l:'ColÃ¨re',e:'ðŸ˜¡'},{l:'Peur',e:'ðŸ˜°'},{l:'Tristesse',e:'ðŸ˜¢'},{l:'Honte',e:'ðŸ˜³'},{l:'Vide',e:'ðŸ˜¶'},{l:'Calme',e:'ðŸ˜Œ'},{l:'Joie',e:'ðŸ¤©'},{l:'Confiance',e:'ðŸ¦'}];
    const STRATEGIES = [{l:"J'en parle",i:"MessageCircle"}, {l:"Musique",i:"Play"}, {l:"Je m'isole",i:"Moon"}, {l:"Je bouge",i:"Activity"}, {l:"Ã‰crans",i:"Fingerprint"}, {l:"CrÃ©ation",i:"Sparkles"}, {l:"Gratitude",i:"Heart"}, {l:"Je savoure",i:"Sun"}];
    const HERO_QUIZ = [
      { cat: 'competence', q: "Je finis ce que je commence." }, { cat: 'competence', q: "Je sais rÃ©soudre mes galÃ¨res." }, { cat: 'competence', q: "J'ai des talents." },
      { cat: 'knowledge', q: "Je sais dire ce que je ressens." }, { cat: 'knowledge', q: "Je connais mes forces." },
      { cat: 'security', q: "Je me sens bien dans ma peau." }, { cat: 'security', q: "L'avenir ne m'effraie pas." },
      { cat: 'belonging', q: "Je me sens aimÃ©(e)." }, { cat: 'belonging', q: "J'ai ma place dans un groupe." }
    ];

    /* --- 4. COMPOSANTS UI --- */
    const Glass = ({ children, onClick, className="" }) => React.createElement("div", {onClick, className:`glass rounded-3xl overflow-hidden ${className}`}, children);
    const Btn = ({ onClick, children, variant='primary', disabled, className="" }) => {
      const s = { primary: "bg-[#2A9D8F] text-white shadow-lg", secondary: "bg-white border border-gray-200 text-gray-600", accent: "bg-[#FF8FAB] text-white", gold: "bg-[#E9C46A] text-white" };
      return React.createElement("button", {onClick, disabled, className:`px-5 py-4 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 shadow-sm ${s[variant]} ${className}`}, children);
    };

    /* --- 5. MODULES --- */
    const SOS = ({ close }) => React.createElement("div", {className:"fixed inset-0 z-50 bg-white/95 flex items-center justify-center p-6 anim-fade"},
      React.createElement("div", {className:"w-full max-w-sm glass border-red-500/30 p-6 text-center shadow-2xl"},
        React.createElement("div", {className:"w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 anim-pulse"}, React.createElement(Icon, {name:"AlertTriangle", size:48})),
        React.createElement("h2", {className:"text-3xl font-black text-gray-800 mb-6"}, "Besoin d'aide ?"),
        React.createElement("div", {className:"space-y-3"},
          React.createElement("a", {href:"tel:3114", className:"block w-full bg-red-600 text-white font-bold py-4 rounded-xl flex justify-center gap-3 shadow-lg"}, React.createElement(Icon, {name:"Phone"}), " 31 14 (Ã‰coute)"),
          React.createElement("a", {href:"tel:15", className:"block w-full bg-white text-slate-900 font-bold py-4 rounded-xl flex justify-center gap-2 shadow-lg"}, React.createElement(Icon, {name:"Activity"}), " 15 (Urgence)")
        ),
        React.createElement("button", {onClick:close, className:"mt-10 text-slate-500 font-bold text-sm tracking-widest uppercase"}, "RETOUR")
      )
    );

    const Auth = ({ login }) => {
      const [u, setU] = React.useState(''); const [p, setP] = React.useState('');
      return React.createElement("div", {className:"h-full flex flex-col items-center justify-center p-8 anim-fade bg-[#FDFBF7]"},
        React.createElement("div", {className:"w-24 h-24 rounded-full bg-[#FF8FAB] flex items-center justify-center shadow-lg mb-6"}, React.createElement(Icon, {name:"Logo", size:48, color:"white"})),
        React.createElement("h1", {className:"text-4xl font-black text-[#2D3748] mb-2"}, "TheraSpace"),
        React.createElement("div", {className:"w-full space-y-4"},
          React.createElement("input", {placeholder:"Pseudo", value:u, onChange:e=>setU(e.target.value), className:"input-soft"}),
          React.createElement("input", {type:"password", placeholder:"Mot de passe", value:p, onChange:e=>setP(e.target.value), className:"input-soft"}),
          React.createElement(Btn, {onClick:()=>login({name:u}), disabled:!u||!p, className:"w-full mt-4"}, "Entrer")
        )
      );
    };

    const Dashboard = ({ nav, user }) => {
      const [sos, setSos] = React.useState(false);
      return React.createElement("div", {className:"h-full overflow-y-auto no-scroll p-6 pt-10 pb-32 space-y-6 anim-fade relative"},
        sos && React.createElement(SOS, {close:()=>setSos(false)}),
        React.createElement("header", {className:"flex justify-between items-center mb-4"},
          React.createElement("div", {}, React.createElement("h1", {className:"text-3xl font-black text-[#2D3748]"}, `Salut ${user.name}`), React.createElement("p", {className:"text-teal-600 text-sm font-medium"}, "Espace SÃ©curisÃ©")),
          React.createElement("button", {onClick:()=>setSos(true), className:"w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-red-500 anim-pulse"}, React.createElement(Icon, {name:"AlertTriangle"}))
        ),
        React.createElement("div", {onClick:()=>nav('echo'), className:"active:scale-95 transition-transform"}, React.createElement(Glass, {className:"p-8 flex justify-between items-center relative overflow-hidden h-40 bg-[#FF8FAB] text-white"},
          React.createElement("div", {}, React.createElement("h3", {className:"text-3xl font-black mb-2"}, "Ã‰CHO"), React.createElement("p", {className:"opacity-90 text-sm"}, "Exploration guidÃ©e")),
          React.createElement("div", {className:"w-20 h-20 rounded-full bg-white/20 flex items-center justify-center"}, React.createElement(Icon, {name:"Echo", size:40, color:"white"}))
        )),
        React.createElement("div", {className:"grid grid-cols-2 gap-4"},
          React.createElement(Glass, {className:"p-6 h-32 flex flex-col justify-between active:scale-95 bg-[#2A9D8F] text-white", onClick:()=>nav('therapist')}, React.createElement(Icon, {name:"Therapist", size:32, color:"white"}), React.createElement("h4", {className:"font-bold text-lg"}, "Psy Virtuel")),
          React.createElement(Glass, {className:"p-6 h-32 flex flex-col justify-between active:scale-95 bg-[#E9C46A] text-white", onClick:()=>nav('oracle')}, React.createElement(Icon, {name:"Oracle", size:32, color:"white"}), React.createElement("h4", {className:"font-bold text-lg"}, "Oracle"))
        ),
        React.createElement("div", {className:"grid grid-cols-2 gap-4"},
          React.createElement(Glass, {className:"p-6 h-32 flex flex-col justify-between active:scale-95 bg-white text-gray-800", onClick:()=>nav('hero')}, React.createElement(Icon, {name:"Hero", className:"text-orange-400", size:32}), React.createElement("h4", {className:"font-bold text-lg"}, "HÃ©ros")),
          React.createElement(Glass, {className:"p-6 h-32 flex flex-col justify-between active:scale-95 bg-white text-gray-800", onClick:()=>nav('journal')}, React.createElement(Icon, {name:"Journal", className:"text-teal-500", size:32}), React.createElement("h4", {className:"font-bold text-lg"}, "Journal"))
        )
      );
    };

    const Echo = ({ exit }) => {
        const [cards, setCards] = React.useState([]); const [idx, setIdx] = React.useState(0); const [step, setStep] = React.useState('load'); const [hist, setHist] = React.useState([]); const [curr, setCurr] = React.useState({emotions:[], strategies:[]}); const [aiRes, setAiRes] = React.useState(null);
        useEffect(() => { const timer = setTimeout(() => { if(cards.length===0) setCards(Array.from({length:15},(_,i)=>({id:i, text:`Situation ${i+1}...`, type:"neu"}))); setStep('play'); }, 4000); callAPI('GENERATE_SCENARIOS').then(d => { clearTimeout(timer); setCards(d); setStep('play'); }); }, []);
        const next = () => { const newHist = [...hist, {card:cards[idx], ...curr}]; if(idx<cards.length-1) { setHist(newHist); setIdx(idx+1); setStep('play'); setCurr({emotions:[], strategies:[]}); } else { setStep('analyzing'); callAPI('ANALYZE_ECHO', newHist).then(res => { setAiRes(res); setStep('feedback'); }); } };
        const toggle = (l, i) => l.includes(i) ? l.filter(x=>x!==i) : [...l, i];
        if(step==='load') return React.createElement("div", {className:"h-full flex flex-col items-center justify-center text-center"}, React.createElement(Icon, {name:"Sparkles", className:"animate-spin text-[#FF8FAB] mb-4", size:48}), React.createElement("h2", {className:"text-2xl font-bold mb-2 text-[#2D3748]"}, "Ã‰CHO..."), React.createElement("p", {className:"text-gray-400"}, "Est-ce que Ã§a rÃ©sonne en toi ?"));
        if(step==='analyzing') return React.createElement("div", {className:"h-full flex flex-col items-center justify-center text-center"}, React.createElement(Icon, {name:"Zap", className:"animate-pulse text-[#2A9D8F] mb-4", size:48}), React.createElement("p", {className:"text-gray-600"}, "Analyse de ta session..."));
        if(step==='feedback') return React.createElement("div", {className:"h-full p-6 pt-10 anim-fade bg-white overflow-y-auto"}, React.createElement("h2", {className:"text-2xl font-black mb-6 text-[#2D3748]"}, "Bilan IA"), React.createElement("div", {className:"card bg-blue-50 border-blue-100 p-6 mb-4 text-center"}, React.createElement("div", {className:"w-16 h-16 mx-auto mb-2 text-blue-500"}, React.createElement(Icon, {name:aiRes?.weather?.icon || "Sun", size:48})), React.createElement("h3", {className:"font-bold text-blue-800"}, "MÃ©tÃ©o"), React.createElement("p", {className:"text-blue-600 text-sm mt-2"}, aiRes?.weather?.text)), React.createElement("div", {className:"card bg-white border-gray-100 p-6 mb-6"}, React.createElement("h3", {className:"font-bold text-gray-800 mb-2"}, "ComprÃ©hension"), React.createElement("p", {className:"text-gray-600 text-sm leading-relaxed"}, aiRes?.analysis)), React.createElement(Btn, {onClick:exit, variant:"secondary", className:"w-full"}, "Terminer"));
        const card = cards[idx] || {text:"..."};
        const interaction = curr.emotions.length > 0 || curr.strategies.length > 0;
        if(step==='play') return React.createElement("div", {className:"h-full flex flex-col p-6 pt-10 bg-[#FF8FAB] text-white"},
            React.createElement("div", {className:"flex justify-between mb-6"}, React.createElement("button", {onClick:exit}, React.createElement(Icon, {name:"X", color:"white"})), React.createElement("span", {}, `${idx+1}/15`), React.createElement("div", {})),
            React.createElement(Glass, {className:"flex-1 flex flex-col relative overflow-hidden bg-white/10 backdrop-blur-xl border-white/20"},
                !interaction ? 
                React.createElement("div", {className:"flex-1 flex flex-col justify-center items-center p-8 text-center anim-slide"}, React.createElement("h2", {className:"text-2xl font-black leading-snug mb-12"}, `"${card.text}"`), React.createElement("div", {className:"grid grid-cols-2 gap-4 w-full mt-auto"}, React.createElement(Btn, {className:"bg-white/20 border border-white/40", onClick:()=>next()}, "Pas vÃ©cu"), React.createElement(Btn, {className:"bg-white text-pink-500", onClick:()=>setCurr({...curr, emotions:['vu']})}, "VÃ©cu"))) : 
                React.createElement("div", {className:"flex-1 flex flex-col p-6 overflow-y-auto bg-white rounded-3xl text-gray-800"}, React.createElement("div", {className:"space-y-6"}, React.createElement("div", {}, React.createElement("p", {className:"text-gray-400 text-xs font-bold uppercase mb-2"}, "Comment tu t'es senti(e) ?"), React.createElement("div", {className:"flex flex-wrap gap-2"}, EMOTIONS.map(e=>React.createElement("button", {key:e.l, onClick:()=>setCurr({...curr, emotions:toggle(curr.emotions, e.l)}), className:`px-3 py-2 rounded-xl border text-sm font-bold flex gap-2 ${curr.emotions.includes(e.l)?'bg-pink-100 border-pink-200 text-pink-600':'bg-gray-50 border-gray-100 text-gray-500'}`}, e.e, " ", e.l)))), React.createElement("div", {}, React.createElement("p", {className:"text-gray-400 text-xs font-bold uppercase mb-2"}, "Ta rÃ©action ?"), React.createElement("div", {className:"grid grid-cols-2 gap-2"}, STRATEGIES.map(s=>{const I=s.i; return React.createElement("button", {key:s.l, onClick:()=>setCurr({...curr, strategies:toggle(curr.strategies, s.l)}), className:`p-3 rounded-xl border text-sm font-bold flex flex-col items-center gap-2 ${curr.strategies.includes(s.l)?'bg-teal-100 border-teal-200 text-teal-700':'bg-gray-50 border-gray-100 text-gray-500'}`}, React.createElement(Icon, {name:s.i, size:18}), " ", s.l)})))), React.createElement(Btn, {onClick:next, className:"mt-8 w-full"}, "Suivant"))
            )
        );
    };

    const Hero = ({ exit }) => {
        const [s, setS] = React.useState('intro'); const [q, setQ] = React.useState(0); const [sc, setSc] = React.useState({competence:0,knowledge:0,security:0,belon
